{% extends 'admin/layout.html' %}
{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Edit Election Â· {{ election.name }}</h2>
  <div class="d-flex gap-2 align-items-center">
    <span class="badge {{ 'bg-success' if election.is_open() else 'bg-secondary' }}">{{ 'Open' if election.is_open() else 'Closed' }}</span>
    <span class="badge bg-info text-dark text-uppercase">Code: {{ election.access_code }}</span>
    {% if session.get('is_super_admin') %}
      <!-- delete button for the brave -->
      <form method="post" action="{{ url_for('admin.delete_election', election_id=election.id) }}" onsubmit="return confirm('Delete this election forever?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
      </form>
    {% endif %}
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">Election Details</h5>
    <form method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Name</label>
          <input class="form-control" name="name" value="{{ election.name }}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Access code</label>
          <input class="form-control text-uppercase" name="access_code" value="{{ election.access_code }}" required>
          <div class="form-text">Provide this code to voters with their unique keys.</div>
        </div>
        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea class="form-control" name="description" rows="2">{{ election.description }}</textarea>
        </div>
        <div class="col-md-4">
          <label class="form-label">Start time (local)</label>
          <input type="datetime-local" class="form-control" name="start_time" value="{{ election.start_time.strftime('%Y-%m-%dT%H:%M') if election.start_time }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">End time (local)</label>
          <input type="datetime-local" class="form-control" name="end_time" value="{{ election.end_time.strftime('%Y-%m-%dT%H:%M') if election.end_time }}">
        </div>
        <div class="col-md-4 d-flex align-items-center">
          <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" name="is_active" id="is_active" {{ 'checked' if election.is_active else '' }}>
            <label class="form-check-label" for="is_active">Election is active</label>
          </div>
        </div>
        <div class="col-12">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Primary color</label>
              <input type="color" class="form-control form-control-color" name="theme_primary" value="{{ election.theme_primary or '#0d6efd' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Secondary color</label>
              <input type="color" class="form-control form-control-color" name="theme_secondary" value="{{ election.theme_secondary or '#6610f2' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Accent color</label>
              <input type="color" class="form-control form-control-color" name="theme_accent" value="{{ election.theme_accent or '#f0ad4e' }}">
            </div>
          </div>
        </div>
      </div>
      <div class="mt-3 d-flex justify-content-end">
        <button class="btn btn-primary" type="submit">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">Add Position</h5>
    <form method="post" action="{{ url_for('admin.create_position', election_id=election.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="next" value="{{ url_for('admin.edit_election', election_id=election.id) }}">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Position name</label>
          <input class="form-control" name="name" placeholder="e.g. President" required>
        </div>
        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea class="form-control" name="description" rows="2" placeholder="Describe the role"></textarea>
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-outline-primary" type="submit">Add Position</button>
      </div>
    </form>
  </div>
</div>

<h4 class="mb-3">Positions & Candidates</h4>
{% if positions %}
  <div data-position-list data-csrf-token="{{ csrf_token() }}">
  {% for position in positions %}
    {% set total_candidates = position.candidates|length %}
    <div class="card mb-4">
      <div class="card-body" data-position-id="{{ position.id }}">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">{{ position.name }}</h5>
          <span class="badge bg-secondary">{{ total_candidates }} candidate{{ 's' if total_candidates != 1 else '' }}</span>
        </div>
        <form method="post" action="{{ url_for('admin.update_position', position_id=position.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="next" value="{{ url_for('admin.edit_election', election_id=election.id) }}">
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Position name</label>
              <input class="form-control" name="name" value="{{ position.name }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="1">{{ position.description }}</textarea>
            </div>
          </div>
          <div class="mt-3 text-end">
            <button class="btn btn-outline-secondary btn-sm" type="submit">Update Position</button>
          </div>
        </form>
        <div class="d-flex justify-content-end gap-2 mb-3">
          <form method="post" action="{{ url_for('admin.move_position', position_id=position.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="direction" value="up">
            <button class="btn btn-outline-primary btn-sm" type="submit" title="Move up">&uarr;</button>
          </form>
          <form method="post" action="{{ url_for('admin.move_position', position_id=position.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="direction" value="down">
            <button class="btn btn-outline-primary btn-sm" type="submit" title="Move down">&darr;</button>
          </form>
        </div>
        <hr>
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3" data-candidate-list data-position-id="{{ position.id }}">
          {% for candidate in position.candidates %}
            <div class="col js-draggable-card" data-candidate-id="{{ candidate.id }}" draggable="true">
              <div class="card h-100">
                {% if candidate.photo_url %}
                  {% if candidate.photo_url.startswith('http') %}
                    {% set candidate_image = candidate.photo_url %}
                  {% else %}
                    {% set candidate_image = url_for('static', filename=candidate.photo_url) %}
                  {% endif %}
                {% else %}
                  {% set candidate_image = url_for('static', filename='img/placeholder-male.png') %}
                {% endif %}
                <div class="ratio ratio-5x4">
                  <img src="{{ candidate_image }}" class="candidate-photo" alt="{{ candidate.name }}" loading="lazy" decoding="async">
                </div>
                <div class="card-body">
                  <div class="d-flex align-items-center gap-2 text-muted mb-2">
                    <i class="bi bi-grip-vertical"></i>
                    <small>Drag to reorder</small>
                  </div>
                  <form method="post" action="{{ url_for('admin.update_candidate', candidate_id=candidate.id) }}" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="next" value="{{ url_for('admin.edit_election', election_id=election.id) }}">
                    <div class="mb-2">
                      <label class="form-label">Candidate name</label>
                      <input class="form-control" name="name" value="{{ candidate.name }}" required>
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Bio / details</label>
                      <textarea class="form-control" name="description" rows="2">{{ candidate.description }}</textarea>
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Photo</label>
                      <input type="file" class="form-control" name="photo" accept="image/*">
                      <div class="mt-2">
                        <label class="form-label">Placeholder</label>
                        <select class="form-select" name="placeholder_choice">
                          <option value="male" {{ 'selected' if (candidate.photo_url or '').endswith('placeholder-male.png') else '' }}>Male</option>
                          <option value="female" {{ 'selected' if (candidate.photo_url or '').endswith('placeholder-female.png') else '' }}>Female</option>
                        </select>
                      </div>
                      <div class="form-check mt-1">
                        <input class="form-check-input" type="checkbox" name="remove_photo" id="remove_photo_{{ candidate.id }}">
                        <label class="form-check-label" for="remove_photo_{{ candidate.id }}">Use placeholder image</label>
                      </div>
                    </div>
                    <button class="btn btn-outline-primary btn-sm" type="submit">Save Candidate</button>
                  </form>
                </div>
              </div>
            </div>
          {% else %}
            <div class="col-12">
              <div class="alert alert-info">No candidates yet for this position.</div>
            </div>
          {% endfor %}
        </div>
        <div class="border-top pt-3">
          <h6>Add Candidate</h6>
          <form method="post" action="{{ url_for('admin.create_candidate', position_id=position.id) }}" enctype="multipart/form-data" class="row g-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="next" value="{{ url_for('admin.edit_election', election_id=election.id) }}">
            <div class="col-md-4">
              <label class="form-label">Name</label>
              <input class="form-control" name="name" required>
            </div>
            <div class="col-md-5">
              <label class="form-label">Bio / details</label>
              <input class="form-control" name="description">
            </div>
              <div class="col-md-3">
                <label class="form-label">Photo</label>
                <input type="file" class="form-control" name="photo" accept="image/*">
              </div>
              <div class="col-md-3">
                <label class="form-label">Placeholder</label>
                <select class="form-select" name="placeholder_choice">
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
              </div>
            <div class="col-12">
              <button class="btn btn-outline-success btn-sm" type="submit">Add Candidate</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}
  </div>
{% else %}
  <p>No positions created yet. Use the form above to get started.</p>
{% endif %}
{% endblock %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const csrfToken = document.querySelector('[data-position-list]')?.dataset?.csrfToken;
    if (!csrfToken) return;

    function setupDragList(container, itemSelector, endpointBuilder) {
      let draggedItem = null;
      container.addEventListener('dragstart', function (event) {
        const item = event.target.closest(itemSelector);
        if (!item) return;
        draggedItem = item;
        event.dataTransfer.effectAllowed = 'move';
        item.classList.add('opacity-50');
      });
      container.addEventListener('dragend', function () {
        if (draggedItem) draggedItem.classList.remove('opacity-50');
        draggedItem = null;
      });
      container.addEventListener('dragover', function (event) {
        event.preventDefault();
        const target = event.target.closest(itemSelector);
        if (!target || target === draggedItem) return;
        const rect = target.getBoundingClientRect();
        const shouldInsertAfter = (event.clientY - rect.top) > rect.height / 2;
        container.insertBefore(draggedItem, shouldInsertAfter ? target.nextSibling : target);
      });
      container.addEventListener('drop', function (event) {
        event.preventDefault();
        if (!draggedItem) return;
        const ids = Array.from(container.querySelectorAll(itemSelector)).map((item) => item.dataset.positionId || item.dataset.candidateId);
        const payload = { order: ids.map((id) => parseInt(id, 10)) };
        const endpoint = endpointBuilder(container);
        fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          body: JSON.stringify(payload),
        }).catch(() => {});
      });
    }

    const positionList = document.querySelector('[data-position-list]');

    document.querySelectorAll('[data-candidate-list]').forEach(function (list) {
      setupDragList(list, '[data-candidate-id]', function (container) {
        return '/admin/positions/' + container.dataset.positionId + '/candidates/reorder';
      });
    });
  });
</script>
